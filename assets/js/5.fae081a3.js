(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{193:function(t,s,e){"use strict";e.r(s);var n=e(0),a=Object(n.a)({},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),e("p",[t._v("I would like to thanks "),e("a",{attrs:{href:"https://github.com/vincentbernat",target:"_blank",rel:"noopener noreferrer"}},[t._v("vincentbernat"),e("OutboundLink")],1),t._v(" from "),e("a",{attrs:{href:"https://www.exoscale.ch",target:"_blank",rel:"noopener noreferrer"}},[t._v("exoscale.ch"),e("OutboundLink")],1),t._v(" who kindly provided the infrastructure needed for the benchmarks.")]),t._v(" "),e("p",[t._v("I used 4 VMs for the tests with the following configuration:")]),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),e("ol",[e("li",[t._v("One VM used to launch the benchmarking tool "),e("a",{attrs:{href:"https://github.com/wg/wrk",target:"_blank",rel:"noopener noreferrer"}},[t._v("wrk"),e("OutboundLink")],1)]),t._v(" "),e("li",[t._v("One VM for Traefik (v1.0.0-beta.416) / nginx (v1.4.6)")]),t._v(" "),e("li",[t._v("Two VMs for 2 backend servers in go "),e("a",{attrs:{href:"https://github.com/containous/whoami/",target:"_blank",rel:"noopener noreferrer"}},[t._v("whoami"),e("OutboundLink")],1)])]),t._v(" "),e("p",[t._v("Each VM has been tuned using the following limits:")]),t._v(" "),t._m(4),t._m(5),t._v(" "),t._m(6),t._v(" "),t._m(7),e("p",[t._v("Here is the Nginx vhost file used:")]),t._v(" "),t._m(8),t._m(9),t._v(" "),t._m(10),t._v(" "),t._m(11),t._m(12),t._v(" "),t._m(13),t._v(" "),t._m(14),t._m(15),t._v(" "),t._m(16),t._m(17),t._v(" "),t._m(18),t._m(19),t._v(" "),e("p",[t._v("Traefik is obviously slower than Nginx, but not so much: Traefik can serve 28392 requests/sec and Nginx 33591 requests/sec which gives a ratio of 85%.\nNot bad for young project ðŸ˜ƒ !")]),t._v(" "),e("p",[t._v("Some areas of possible improvements:")]),t._v(" "),e("ul",[e("li",[t._v("Use "),e("a",{attrs:{href:"https://github.com/kavu/go_reuseport",target:"_blank",rel:"noopener noreferrer"}},[t._v("GO_REUSEPORT"),e("OutboundLink")],1),t._v(" listener")]),t._v(" "),t._m(20)])])},[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"benchmarks"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#benchmarks","aria-hidden":"true"}},[this._v("#")]),this._v(" Benchmarks")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"configuration"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#configuration","aria-hidden":"true"}},[this._v("#")]),this._v(" Configuration")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[this._v("32 GB RAM")]),this._v(" "),s("li",[this._v("8 CPU Cores")]),this._v(" "),s("li",[this._v("10 GB SSD")]),this._v(" "),s("li",[this._v("Ubuntu 14.04 LTS 64-bit")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"setup"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#setup","aria-hidden":"true"}},[this._v("#")]),this._v(" Setup")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("sysctl -w fs.file-max"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"9999999"')]),t._v("\nsysctl -w fs.nr_open"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"9999999"')]),t._v("\nsysctl -w net.core.netdev_max_backlog"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"4096"')]),t._v("\nsysctl -w net.core.rmem_max"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"16777216"')]),t._v("\nsysctl -w net.core.somaxconn"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"65535"')]),t._v("\nsysctl -w net.core.wmem_max"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"16777216"')]),t._v("\nsysctl -w net.ipv4.ip_local_port_range"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1025       65535"')]),t._v("\nsysctl -w net.ipv4.tcp_fin_timeout"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"30"')]),t._v("\nsysctl -w net.ipv4.tcp_keepalive_time"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"30"')]),t._v("\nsysctl -w net.ipv4.tcp_max_syn_backlog"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"20480"')]),t._v("\nsysctl -w net.ipv4.tcp_max_tw_buckets"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"400000"')]),t._v("\nsysctl -w net.ipv4.tcp_no_metrics_save"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),t._v("\nsysctl -w net.ipv4.tcp_syn_retries"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2"')]),t._v("\nsysctl -w net.ipv4.tcp_synack_retries"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2"')]),t._v("\nsysctl -w net.ipv4.tcp_tw_recycle"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),t._v("\nsysctl -w net.ipv4.tcp_tw_reuse"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),t._v("\nsysctl -w vm.min_free_kbytes"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"65536"')]),t._v("\nsysctl -w vm.overcommit_memory"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ulimit")]),t._v(" -n 9999999\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"nginx"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx","aria-hidden":"true"}},[this._v("#")]),this._v(" Nginx")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("Here is the config Nginx file use "),s("code",[this._v("/etc/nginx/nginx.conf")]),this._v(":")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[this._v("user www-data;\nworker_processes auto;\nworker_rlimit_nofile 200000;\npid /var/run/nginx.pid;\n\nevents {\n    worker_connections 10000;\n    use epoll;\n    multi_accept on;\n}\n\nhttp {\n    sendfile on;\n    tcp_nopush on;\n    tcp_nodelay on;\n    keepalive_timeout 300;\n    keepalive_requests 10000;\n    types_hash_max_size 2048;\n\n    open_file_cache max=200000 inactive=300s;\n    open_file_cache_valid 300s;\n    open_file_cache_min_uses 2;\n    open_file_cache_errors on;\n\n    server_tokens off;\n    dav_methods off;\n\n    include /etc/nginx/mime.types;\n    default_type application/octet-stream;\n\n    access_log /var/log/nginx/access.log combined;\n    error_log /var/log/nginx/error.log warn;\n\n    gzip off;\n    gzip_vary off;\n\n    include /etc/nginx/conf.d/*.conf;\n    include /etc/nginx/sites-enabled/*.conf;\n}\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[this._v('upstream whoami {\n    server IP-whoami1:80;\n    server IP-whoami2:80;\n    keepalive 300;\n}\n\nserver {\n    listen 8001;\n    server_name test.traefik;\n    access_log off;\n    error_log /dev/null crit;\n    if ($host != "test.traefik") {\n        return 404;\n    }\n    location / {\n        proxy_pass http://whoami;\n        proxy_http_version 1.1;\n        proxy_set_header Connection "";\n\tproxy_set_header  X-Forwarded-Host $host;\n    }\n}\n')])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"traefik"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#traefik","aria-hidden":"true"}},[this._v("#")]),this._v(" Traefik")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("Here is the "),s("code",[this._v("traefik.toml")]),this._v(" file used:")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-ini extra-class"},[e("pre",{pre:!0,attrs:{class:"language-ini"}},[e("code",[e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("maxIdleConnsPerHost")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 100000")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("defaultEntryPoints")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(' ["http"]')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[entryPoints]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token selector"}},[t._v("  [entryPoints.http]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("  address")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(' ":8000"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[file]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[backends]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token selector"}},[t._v("  [backends.backend1]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token selector"}},[t._v("    [backends.backend1.servers.server1]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("    url")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(' "http://IP-whoami1:80"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("    weight")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 1")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token selector"}},[t._v("    [backends.backend1.servers.server2]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("    url")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(' "http://IP-whoami2:80"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("    weight")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" 1")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[frontends]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token selector"}},[t._v("  [frontends.frontend1]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("  backend")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(' "backend1"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token selector"}},[t._v("    [frontends.frontend1.routes.test_1]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("    rule")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(' "Host: test.traefik"')]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"results"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#results","aria-hidden":"true"}},[this._v("#")]),this._v(" Results")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"whoami"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#whoami","aria-hidden":"true"}},[this._v("#")]),this._v(" whoami:")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("wrk -t20 -c1000 -d60s -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Host: test.traefik"')]),t._v(" --latency  http://IP-whoami:80/bench\nRunning 1m "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),t._v(" @ http://IP-whoami:80/bench\n  20 threads and 1000 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency    70.28ms  134.72ms   1.91s    89.94%\n    Req/Sec     2.92k   742.42     8.78k    68.80%\n  Latency Distribution\n     50%   10.63ms\n     75%   75.64ms\n     90%  205.65ms\n     99%  668.28ms\n  3476705 requests "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" 1.00m, 384.61MB "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),t._v("\n  Socket errors: connect 0, "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),t._v(" 0, "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),t._v(" 0, "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeout")]),t._v(" 103\nRequests/sec:  57894.35\nTransfer/sec:      6.40MB\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"nginx-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-2","aria-hidden":"true"}},[this._v("#")]),this._v(" nginx:")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("wrk -t20 -c1000 -d60s -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Host: test.traefik"')]),t._v(" --latency  http://IP-nginx:8001/bench\nRunning 1m "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),t._v(" @ http://IP-nginx:8001/bench\n  20 threads and 1000 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency   101.25ms  180.09ms   1.99s    89.34%\n    Req/Sec     1.69k   567.69     9.39k    72.62%\n  Latency Distribution\n     50%   15.46ms\n     75%  129.11ms\n     90%  302.44ms\n     99%  846.59ms\n  2018427 requests "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" 1.00m, 298.36MB "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),t._v("\n  Socket errors: connect 0, "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),t._v(" 0, "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),t._v(" 0, "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeout")]),t._v(" 90\nRequests/sec:  33591.67\nTransfer/sec:      4.97MB\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"traefik-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#traefik-2","aria-hidden":"true"}},[this._v("#")]),this._v(" Traefik:")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("wrk -t20 -c1000 -d60s -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Host: test.traefik"')]),t._v(" --latency  http://IP-traefik:8000/bench\nRunning 1m "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),t._v(" @ http://IP-traefik:8000/bench\n  20 threads and 1000 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency    91.72ms  150.43ms   2.00s    90.50%\n    Req/Sec     1.43k   266.37     2.97k    69.77%\n  Latency Distribution\n     50%   19.74ms\n     75%  121.98ms\n     90%  237.39ms\n     99%  687.49ms\n  1705073 requests "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" 1.00m, 188.63MB "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),t._v("\n  Socket errors: connect 0, "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),t._v(" 0, "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),t._v(" 0, "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeout")]),t._v(" 7\nRequests/sec:  28392.44\nTransfer/sec:      3.14MB\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"conclusion"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#conclusion","aria-hidden":"true"}},[this._v("#")]),this._v(" Conclusion")])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[this._v("Run a separate server instance per CPU core with "),s("code",[this._v("GOMAXPROCS=1")]),this._v(" (it appears during benchmarks that there is a lot more context switches with Traefik than with nginx)")])}],!1,null,null,null);s.default=a.exports}}]);