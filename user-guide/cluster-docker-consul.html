<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Clustering / High Availability on Docker Swarm with Consul | Traefik</title>
    <meta name="description" content="Traefik Documentation">
    
    
    <link rel="preload" href="/traefik/assets/css/0.styles.ff21fc36.css" as="style"><link rel="preload" href="/traefik/assets/js/app.ae787784.js" as="script"><link rel="preload" href="/traefik/assets/js/30.e4524922.js" as="script"><link rel="prefetch" href="/traefik/assets/js/10.d9f32ac0.js"><link rel="prefetch" href="/traefik/assets/js/11.375b726e.js"><link rel="prefetch" href="/traefik/assets/js/12.9acb0324.js"><link rel="prefetch" href="/traefik/assets/js/13.8f411b20.js"><link rel="prefetch" href="/traefik/assets/js/14.5aa54c49.js"><link rel="prefetch" href="/traefik/assets/js/15.18320535.js"><link rel="prefetch" href="/traefik/assets/js/16.f386789a.js"><link rel="prefetch" href="/traefik/assets/js/17.7c01ac03.js"><link rel="prefetch" href="/traefik/assets/js/18.3c97b5d1.js"><link rel="prefetch" href="/traefik/assets/js/19.1483f0a7.js"><link rel="prefetch" href="/traefik/assets/js/2.f0fe713b.js"><link rel="prefetch" href="/traefik/assets/js/20.0485452d.js"><link rel="prefetch" href="/traefik/assets/js/21.f2312fc4.js"><link rel="prefetch" href="/traefik/assets/js/22.ee03f9ff.js"><link rel="prefetch" href="/traefik/assets/js/23.647e2047.js"><link rel="prefetch" href="/traefik/assets/js/24.e91ab9c9.js"><link rel="prefetch" href="/traefik/assets/js/25.6d2905c1.js"><link rel="prefetch" href="/traefik/assets/js/26.6b0b7881.js"><link rel="prefetch" href="/traefik/assets/js/27.a1e67edd.js"><link rel="prefetch" href="/traefik/assets/js/28.858e5d66.js"><link rel="prefetch" href="/traefik/assets/js/29.26643758.js"><link rel="prefetch" href="/traefik/assets/js/3.c340e227.js"><link rel="prefetch" href="/traefik/assets/js/31.cb24e220.js"><link rel="prefetch" href="/traefik/assets/js/32.d475b1ed.js"><link rel="prefetch" href="/traefik/assets/js/33.f84e04da.js"><link rel="prefetch" href="/traefik/assets/js/34.bbe37568.js"><link rel="prefetch" href="/traefik/assets/js/35.2c01db0b.js"><link rel="prefetch" href="/traefik/assets/js/36.308bc37c.js"><link rel="prefetch" href="/traefik/assets/js/37.5d1dbe7b.js"><link rel="prefetch" href="/traefik/assets/js/38.9377ad2b.js"><link rel="prefetch" href="/traefik/assets/js/39.e1a55eef.js"><link rel="prefetch" href="/traefik/assets/js/4.90ba113d.js"><link rel="prefetch" href="/traefik/assets/js/40.eea6044f.js"><link rel="prefetch" href="/traefik/assets/js/5.fae081a3.js"><link rel="prefetch" href="/traefik/assets/js/6.a2ec5521.js"><link rel="prefetch" href="/traefik/assets/js/7.3779a4fa.js"><link rel="prefetch" href="/traefik/assets/js/8.58f6dd40.js"><link rel="prefetch" href="/traefik/assets/js/9.96dc80cc.js">
    <link rel="stylesheet" href="/traefik/assets/css/0.styles.ff21fc36.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/traefik/" class="home-link router-link-active"><!----> <span class="site-name">Traefik</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/traefik/" class="sidebar-link">Getting Started</a></li><li><a href="/traefik/basics.html" class="sidebar-link">Basics</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Configuration</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>User Guides</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/traefik/user-guide/examples.html" class="sidebar-link">Configuration Examples</a></li><li><a href="/traefik/user-guide/swarm-mode.html" class="sidebar-link">Swarm Mode Cluster</a></li><li><a href="/traefik/user-guide/swarm.html" class="sidebar-link">Swarm Cluster</a></li><li><a href="/traefik/user-guide/docker-and-lets-encrypt.html" class="sidebar-link">Let's Encrypt &amp; Docker</a></li><li><a href="/traefik/user-guide/kubernetes.html" class="sidebar-link">Kubernetes</a></li><li><a href="/traefik/user-guide/marathon.html" class="sidebar-link">Marathon</a></li><li><a href="/traefik/user-guide/kv-config.html" class="sidebar-link">Key-value Store Configuration</a></li><li><a href="/traefik/user-guide/cluster.html" class="sidebar-link">Clustering/HA</a></li><li><a href="/traefik/user-guide/grpc.html" class="sidebar-link">gRPC Example</a></li><li><a href="/traefik/user-guide/cluster-docker-consul.html" class="active sidebar-link">Traefik cluster example with Swarm</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/traefik/user-guide/cluster-docker-consul.html#prerequisites" class="sidebar-link">Prerequisites</a></li><li class="sidebar-sub-header"><a href="/traefik/user-guide/cluster-docker-consul.html#traefik-configuration" class="sidebar-link">Traefik configuration</a></li><li class="sidebar-sub-header"><a href="/traefik/user-guide/cluster-docker-consul.html#migrate-configuration-to-consul" class="sidebar-link">Migrate configuration to Consul</a></li><li class="sidebar-sub-header"><a href="/traefik/user-guide/cluster-docker-consul.html#deploy-a-traefik-cluster" class="sidebar-link">Deploy a Traefik cluster</a></li><li class="sidebar-sub-header"><a href="/traefik/user-guide/cluster-docker-consul.html#full-docker-compose-file-2" class="sidebar-link">Full docker-compose file</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="clustering-high-availability-on-docker-swarm-with-consul"><a href="#clustering-high-availability-on-docker-swarm-with-consul" aria-hidden="true" class="header-anchor">#</a> Clustering / High Availability on Docker Swarm with Consul</h1> <p>This guide explains how to use Traefik in high availability mode in a Docker Swarm and with Let's Encrypt.</p> <p>Why do we need Traefik in cluster mode? Running multiple instances should work out of the box?</p> <p>If you want to use Let's Encrypt with Traefik, sharing configuration or TLS certificates between many Traefik instances, you need Traefik cluster/HA.</p> <p>Ok, could we mount a shared volume used by all my instances? Yes, you can, but it will not work.
When you use Let's Encrypt, you need to store certificates, but not only.
When Traefik generates a new certificate, it configures a challenge and once Let's Encrypt will verify the ownership of the domain, it will ping back the challenge.
If the challenge is not known by other Traefik instances, the validation will fail.</p> <p>For more information about the challenge: <a href="https://github.com/ietf-wg-acme/acme/blob/master/draft-ietf-acme-acme.md#http-challenge" target="_blank" rel="noopener noreferrer">Automatic Certificate Management Environment (ACME)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="prerequisites"><a href="#prerequisites" aria-hidden="true" class="header-anchor">#</a> Prerequisites</h2> <p>You will need a working Docker Swarm cluster.</p> <h2 id="traefik-configuration"><a href="#traefik-configuration" aria-hidden="true" class="header-anchor">#</a> Traefik configuration</h2> <p>In this guide, we will not use a TOML configuration file, but only command line flag.
With that, we can use the base image without mounting configuration file or building custom image.</p> <p>What Traefik should do:</p> <ul><li>Listen to 80 and 443</li> <li>Redirect HTTP traffic to HTTPS</li> <li>Generate SSL certificate when a domain is added</li> <li>Listen to Docker Swarm event</li></ul> <h3 id="entrypoints-configuration"><a href="#entrypoints-configuration" aria-hidden="true" class="header-anchor">#</a> EntryPoints configuration</h3> <p>TL;DR:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ traefik \
    --entrypoints<span class="token operator">=</span><span class="token string">'Name:http Address::80 Redirect.EntryPoint:https'</span> \
    --entrypoints<span class="token operator">=</span><span class="token string">'Name:https Address::443 TLS'</span> \
    --defaultentrypoints<span class="token operator">=</span>http,https
</code></pre></div><p>To listen to different ports, we need to create an entry point for each.</p> <p>The CLI syntax is <code>--entrypoints='Name:a_name Address:an_ip_or_empty:a_port options'</code>.
If you want to redirect traffic from one entry point to another, it's the option <code>Redirect.EntryPoint:entrypoint_name</code>.</p> <p>By default, we don't want to configure all our services to listen on http and https, we add a default entry point configuration: <code>--defaultentrypoints=http,https</code>.</p> <h3 id="let-s-encrypt-configuration"><a href="#let-s-encrypt-configuration" aria-hidden="true" class="header-anchor">#</a> Let's Encrypt configuration</h3> <p>TL;DR:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ traefik \
    --acme \
    --acme.storage<span class="token operator">=</span>/etc/traefik/acme/acme.json \
    --acme.entryPoint<span class="token operator">=</span>https \
    --acme.httpChallenge.entryPoint<span class="token operator">=</span>http \
    --acme.email<span class="token operator">=</span>contact@mydomain.ca
</code></pre></div><p>Let's Encrypt needs 4 parameters: an TLS entry point to listen to, a non-TLS entry point to allow HTTP challenges, a storage for certificates, and an email for the registration.</p> <p>To enable Let's Encrypt support, you need to add <code>--acme</code> flag.</p> <p>Now, Traefik needs to know where to store the certificates, we can choose between a key in a Key-Value store, or a file path: <code>--acme.storage=my/key</code> or <code>--acme.storage=/path/to/acme.json</code>.</p> <p>The <code>acme.httpChallenge.entryPoint</code> flag enables the <code>HTTP-01</code> challenge and specifies the entryPoint to use during the challenges.</p> <p>For your email and the entry point, it's <code>--acme.entryPoint</code> and <code>--acme.email</code> flags.</p> <h3 id="docker-configuration"><a href="#docker-configuration" aria-hidden="true" class="header-anchor">#</a> Docker configuration</h3> <p>TL;DR:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ traefik \
    --docker \
    --docker.swarmMode \
    --docker.domain<span class="token operator">=</span>mydomain.ca \
    --docker.watch
</code></pre></div><p>To enable docker and swarm-mode support, you need to add <code>--docker</code> and <code>--docker.swarmMode</code> flags.
To watch docker events, add <code>--docker.watch</code>.</p> <h3 id="full-docker-compose-file"><a href="#full-docker-compose-file" aria-hidden="true" class="header-anchor">#</a> Full docker-compose file</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3&quot;</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">traefik</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> traefik<span class="token punctuation">:</span><span class="token number">1.5</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--api&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--entrypoints=Name:http Address::80 Redirect.EntryPoint:https&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--entrypoints=Name:https Address::443 TLS&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--defaultentrypoints=http,https&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme.storage=/etc/traefik/acme/acme.json&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme.entryPoint=https&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme.httpChallenge.entryPoint=http&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme.onHostRule=true&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme.onDemand=false&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme.email=contact@mydomain.ca&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--docker&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--docker.swarmMode&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--docker.domain=mydomain.ca&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--docker.watch&quot;</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/var/run/docker.sock
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> webgateway
      <span class="token punctuation">-</span> traefik
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">published</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> host
      <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> <span class="token number">443</span>
        <span class="token key atrule">published</span><span class="token punctuation">:</span> <span class="token number">443</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> host
      <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> <span class="token number">8080</span>
        <span class="token key atrule">published</span><span class="token punctuation">:</span> <span class="token number">8080</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> host
    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> global
      <span class="token key atrule">placement</span><span class="token punctuation">:</span>
        <span class="token key atrule">constraints</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> node.role == manager
      <span class="token key atrule">update_config</span><span class="token punctuation">:</span>
        <span class="token key atrule">parallelism</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">delay</span><span class="token punctuation">:</span> 10s
      <span class="token key atrule">restart_policy</span><span class="token punctuation">:</span>
        <span class="token key atrule">condition</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>failure
<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">webgateway</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> overlay
    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">traefik</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> overlay
</code></pre></div><h2 id="migrate-configuration-to-consul"><a href="#migrate-configuration-to-consul" aria-hidden="true" class="header-anchor">#</a> Migrate configuration to Consul</h2> <p>We created a special Traefik command to help configuring your Key Value store from a Traefik TOML configuration file and/or CLI flags.</p> <h2 id="deploy-a-traefik-cluster"><a href="#deploy-a-traefik-cluster" aria-hidden="true" class="header-anchor">#</a> Deploy a Traefik cluster</h2> <p>The best way we found is to have an initializer service.
This service will push the config to Consul via the <code>storeconfig</code> sub-command.</p> <p>This service will retry until finishing without error because Consul may not be ready when the service tries to push the configuration.</p> <p>The initializer in a docker-compose file will be:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>  <span class="token key atrule">traefik_init</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> traefik<span class="token punctuation">:</span><span class="token number">1.5</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;storeconfig&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--api&quot;</span>
      <span class="token punctuation">[</span><span class="token punctuation">...</span><span class="token punctuation">]</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--consul&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--consul.endpoint=consul:8500&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--consul.prefix=traefik&quot;</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> traefik
    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
      <span class="token key atrule">restart_policy</span><span class="token punctuation">:</span>
        <span class="token key atrule">condition</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>failure
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> consul
</code></pre></div><p>And now, the Traefik part will only have the Consul configuration.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>  <span class="token key atrule">traefik</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> traefik<span class="token punctuation">:</span><span class="token number">1.5</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> traefik_init
      <span class="token punctuation">-</span> consul
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--consul&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--consul.endpoint=consul:8500&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--consul.prefix=traefik&quot;</span>
    <span class="token punctuation">[</span><span class="token punctuation">...</span><span class="token punctuation">]</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <pre><code>For Traefik &lt;1.5.0 add `acme.storage=traefik/acme/account` because Traefik is not reading it from Consul.
</code></pre></div> <p>If you have some update to do, update the initializer service and re-deploy it.
The new configuration will be stored in Consul, and you need to restart the Traefik node: <code>docker service update --force traefik_traefik</code>.</p> <h2 id="full-docker-compose-file-2"><a href="#full-docker-compose-file-2" aria-hidden="true" class="header-anchor">#</a> Full docker-compose file</h2> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.4&quot;</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">traefik_init</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> traefik<span class="token punctuation">:</span><span class="token number">1.5</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;storeconfig&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--api&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--entrypoints=Name:http Address::80 Redirect.EntryPoint:https&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--entrypoints=Name:https Address::443 TLS&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--defaultentrypoints=http,https&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme.storage=traefik/acme/account&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme.entryPoint=https&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme.httpChallenge.entryPoint=http&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme.onHostRule=true&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme.onDemand=false&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--acme.email=foobar@example.com&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--docker&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--docker.swarmMode&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--docker.domain=example.com&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--docker.watch&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--consul&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--consul.endpoint=consul:8500&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--consul.prefix=traefik&quot;</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> traefik
    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
      <span class="token key atrule">restart_policy</span><span class="token punctuation">:</span>
        <span class="token key atrule">condition</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>failure
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> consul
  <span class="token key atrule">traefik</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> traefik<span class="token punctuation">:</span><span class="token number">1.5</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> traefik_init
      <span class="token punctuation">-</span> consul
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--consul&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--consul.endpoint=consul:8500&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;--consul.prefix=traefik&quot;</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/var/run/docker.sock
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> webgateway
      <span class="token punctuation">-</span> traefik
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">published</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> host
      <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> <span class="token number">443</span>
        <span class="token key atrule">published</span><span class="token punctuation">:</span> <span class="token number">443</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> host
      <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> <span class="token number">8080</span>
        <span class="token key atrule">published</span><span class="token punctuation">:</span> <span class="token number">8080</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> host
    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> global
      <span class="token key atrule">placement</span><span class="token punctuation">:</span>
        <span class="token key atrule">constraints</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> node.role == manager
      <span class="token key atrule">update_config</span><span class="token punctuation">:</span>
        <span class="token key atrule">parallelism</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">delay</span><span class="token punctuation">:</span> 10s
      <span class="token key atrule">restart_policy</span><span class="token punctuation">:</span>
        <span class="token key atrule">condition</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>failure
  <span class="token key atrule">consul</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> consul
    <span class="token key atrule">command</span><span class="token punctuation">:</span> agent <span class="token punctuation">-</span>server <span class="token punctuation">-</span>bootstrap<span class="token punctuation">-</span>expect=1
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> consul<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/consul/data
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> CONSUL_LOCAL_CONFIG=<span class="token punctuation">{</span>&quot;datacenter&quot;<span class="token punctuation">:</span><span class="token string">&quot;us_east2&quot;</span><span class="token punctuation">,</span>&quot;server&quot;<span class="token punctuation">:</span><span class="token boolean important">true</span><span class="token punctuation">}</span>
      <span class="token punctuation">-</span> CONSUL_BIND_INTERFACE=eth0
      <span class="token punctuation">-</span> CONSUL_CLIENT_INTERFACE=eth0
    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
      <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">placement</span><span class="token punctuation">:</span>
        <span class="token key atrule">constraints</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> node.role == manager
      <span class="token key atrule">restart_policy</span><span class="token punctuation">:</span>
        <span class="token key atrule">condition</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>failure
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> traefik

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">webgateway</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> overlay
    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">traefik</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> overlay

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">consul-data</span><span class="token punctuation">:</span>
      <span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>not local<span class="token punctuation">]</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/traefik/user-guide/grpc.html" class="prev">
          gRPC Example
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/traefik/assets/js/app.ae787784.js" defer></script><script src="/traefik/assets/js/30.e4524922.js" defer></script>
  </body>
</html>
